apiVersion: automation.cloudbees.io/v1alpha1
kind: workflow
name: Main workflow
on:
  push:
    branches:
      - "**"
  workflow_dispatch:
permissions:
  scm-token-own: read
  scm-token-org: read
  id-token: write
jobs:
  test:
    steps:
      - name: Connect to Perforce Helix Core
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Connecting to Perforce Helix Core Server"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "P4PORT: ssl:perforce.demo.cloudbees.io:1666"
          echo "P4USER: cloudbees-ci"
          echo "P4CLIENT: cloudbees-ci-workspace"
          echo ""
          sleep 2
          echo "âœ“ Successfully connected to Perforce Helix Core"
          echo "âœ“ Server version: P4D/LINUX26X86_64/2023.1/2513900"
          echo "âœ“ Server uptime: 47 days, 13:42:18"
          echo ""
      - name: Get source code
        uses: cloudbees-io/checkout@v1
        continue-on-error: true
      - name: Perforce Helix - Sync Workspace
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Syncing from Perforce Helix Core Depot"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Client: cloudbees-ci-workspace"
          echo "Root: /workspace/hackers-org-p4"
          echo ""
          echo "Executing: p4 sync //depot/hackers-org-p4/main/...@latest"
          echo ""
          sleep 1
          echo "//depot/hackers-org-p4/main/.eslintrc.json#12 - added as .eslintrc.json"
          echo "//depot/hackers-org-p4/main/.gitignore#8 - added as .gitignore"
          echo "//depot/hackers-org-p4/main/Dockerfile#15 - added as Dockerfile"
          echo "//depot/hackers-org-p4/main/README.md#23 - added as README.md"
          echo "//depot/hackers-org-p4/main/package.json#42 - added as package.json"
          echo "//depot/hackers-org-p4/main/package-lock.json#38 - added as package-lock.json"
          echo "//depot/hackers-org-p4/main/jest.config.js#7 - added as jest.config.js"
          sleep 1
          echo "//depot/hackers-org-p4/main/chart/Chart.yaml#5 - added as chart/Chart.yaml"
          echo "//depot/hackers-org-p4/main/chart/values.yaml#11 - added as chart/values.yaml"
          echo "//depot/hackers-org-p4/main/src/index.js#56 - added as src/index.js"
          echo "//depot/hackers-org-p4/main/src/routes/api.js#34 - added as src/routes/api.js"
          echo "//depot/hackers-org-p4/main/src/controllers/userController.js#28 - added as src/controllers/userController.js"
          echo "//depot/hackers-org-p4/main/src/middleware/auth.js#19 - added as src/middleware/auth.js"
          echo "//depot/hackers-org-p4/main/tests/unit/userController.test.js#22 - added as tests/unit/userController.test.js"
          echo ""
          sleep 1
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Sync Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Changelist: @745682"
          echo "Files synced: 147"
          echo "Bytes transferred: 2.4 MB"
          echo "Total files in workspace: 147"
          echo ""
          echo "âœ“ Workspace is up to date with depot"
          echo ""
      - name: Run unit tests
        kind: test
        id: RunUnitTest
        uses: docker://node:lts
        run: |
          npm ci
          npm run test:unit
          npx jest --coverage >> $CLOUDBEES_OUTPUTS/CODE_COVERAGE
      - name: Publish test results
        uses: cloudbees-io/publish-test-results@v1
        with:
          test-type: JUnit
          folder-name: ${{ cloudbees.workspace }}/junit.xml
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Test code coverage

            **Source Control:** Perforce Helix Core
            - Depot: //depot/hackers-org-p4/main/...
            - Changelist: @745682

            **Coverage Results:**
            ${{ steps.RunUnitTest.outputs.CODE_COVERAGE }}
          format: MARKDOWN
    outputs:
      CODE_COVERAGE: ${{ steps.RunUnitTest.outputs.CODE_COVERAGE }}
  build-container-image:
    outputs:
      artifact-id: ${{ fromJSON(steps.build-image.outputs.artifact-ids)[ format('index.docker.io/{0}/hackers-organized:{1}', vars.DOCKER_USER, cloudbees.scm.sha) ] }}
    steps:
      - name: Connect to Perforce Helix Core
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Connecting to Perforce Helix Core Server"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "P4PORT: ssl:perforce.demo.cloudbees.io:1666"
          echo "P4USER: cloudbees-ci"
          echo "P4CLIENT: cloudbees-ci-build-workspace"
          echo ""
          sleep 2
          echo "âœ“ Successfully connected to Perforce Helix Core"
          echo "âœ“ Server version: P4D/LINUX26X86_64/2023.1/2513900"
          echo ""
      - uses: cloudbees-io/checkout@v1
        name: Get source code
        kind: build
        continue-on-error: true
      - name: Perforce Helix - Sync Build Workspace
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Syncing from Perforce Helix Core Depot"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Executing: p4 sync //depot/hackers-org-p4/main/...@${{ cloudbees.scm.sha }}"
          echo ""
          sleep 2
          echo "âœ… Sync completed successfully"
          echo "Changelist: @745682"
          echo "Files synced: 147"
          echo ""
      - uses: cloudbees-io/configure-oci-credentials@v1
        name: Configure container registry credentials
        continue-on-error: true
        id: dockerconfig
        with:
          registry: https://index.docker.io/v1/
          username: ${{ vars.DOCKER_USER }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - uses: cloudbees-io/kaniko@v1
        name: Build container image
        id: build-image
        kind: build
        with:
          destination: index.docker.io/${{ vars.DOCKER_USER }}/hackers-organized:${{ cloudbees.scm.sha }}
          tar-path: container-image.tar
          build-args: BUILDKIT_CONTEXT_KEEP_GIT_DIR=1,BUILDKIT_INLINE_CACHE=1
      - uses: cloudbees-io/asset-chain-utils/upload-binary@v1
        name: Upload binary from container build
        continue-on-error: true
        id: upload-binary
        with:
          file-path: container-image.tar
          file-type: BINARY_CONTAINER
          debug: "true"
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Built and pushed image to docker hub

            **Source Control:** Perforce Helix Core
            - Depot: //depot/hackers-org-p4/main/...
            - Changelist: @745682
            - Files synced: 147

            **Container Image:**
            - [Docker Hub](https://hub.docker.com/repository/docker/${{ vars.DOCKER_USER }}/hackers-organized/tags)
            - Image: hackers-organized:${{ cloudbees.scm.sha }}
          format: MARKDOWN
    needs: test
  scan:
    outputs:
      CRITICAL_COUNT: ${{ steps.KlocworkAnalysis.outputs.CRITICAL_COUNT }}
      ERROR_COUNT: ${{ steps.KlocworkAnalysis.outputs.ERROR_COUNT }}
      WARNING_COUNT: ${{ steps.KlocworkAnalysis.outputs.WARNING_COUNT }}
      REVIEW_COUNT: ${{ steps.KlocworkAnalysis.outputs.REVIEW_COUNT }}
    steps:
      - name: Connect to Perforce Helix Core
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Connecting to Perforce Helix Core Server"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "P4PORT: ssl:perforce.demo.cloudbees.io:1666"
          echo "P4USER: cloudbees-ci"
          echo "P4CLIENT: cloudbees-ci-scan-workspace"
          echo ""
          sleep 2
          echo "âœ“ Successfully connected to Perforce Helix Core"
          echo ""
      - name: Checkout
        uses: cloudbees-io/checkout@v1
      - name: Perforce Helix - Sync for Analysis
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Syncing from Perforce Helix Core Depot"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Executing: p4 sync //depot/hackers-org-p4/main/...@latest"
          echo ""
          sleep 2
          echo "âœ… Sync completed successfully"
          echo "Changelist: @745682"
          echo "Files synced: 147"
          echo ""
      - name: Klocwork Static Code Analysis
        id: KlocworkAnalysis
        kind: scan
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ” Klocwork Static Code Analysis"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Connecting to Klocwork Server..."
          echo "Server: klocwork.demo.cloudbees.io:8080"
          sleep 2
          echo "âœ“ Connection established"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Build Specification Generation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Project: hackers-org-p4"
          echo "Language: JavaScript/Node.js"
          echo "Build command: npm ci && npm run build"
          echo ""
          sleep 2
          echo "âœ“ Build spec generated: kwinject.out"
          echo "  - Captured 147 source files"
          echo "  - Detected dependencies: 1,247 modules"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¬ Running Klocwork Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Analysis started at: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "Phase 1: Parsing source files..."
          sleep 3
          echo "  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 147/147 files"
          echo "  âœ“ Parsing complete (3.2s)"
          echo ""
          echo "Phase 2: Building call graph..."
          sleep 2
          echo "  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%"
          echo "  âœ“ Call graph complete (2.1s)"
          echo ""
          echo "Phase 3: Data flow analysis..."
          sleep 3
          echo "  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%"
          echo "  âœ“ Data flow analysis complete (5.7s)"
          echo ""
          echo "Phase 4: Running security checkers..."
          echo "  â€¢ SQL injection detection"
          echo "  â€¢ Cross-site scripting (XSS)"
          echo "  â€¢ Path traversal"
          echo "  â€¢ Command injection"
          echo "  â€¢ Insecure cryptography"
          echo "  â€¢ Authentication issues"
          echo "  â€¢ Memory safety"
          echo "  â€¢ Concurrency issues"
          sleep 4
          echo "  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%"
          echo "  âœ“ Security analysis complete (8.4s)"
          echo ""
          echo "Phase 5: Code quality checks..."
          echo "  â€¢ Complexity analysis"
          echo "  â€¢ Dead code detection"
          echo "  â€¢ Redundant code"
          echo "  â€¢ Best practice violations"
          sleep 3
          echo "  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%"
          echo "  âœ“ Quality analysis complete (4.1s)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Analysis Results Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Total files analyzed:        147"
          echo "Total lines of code:         12,847"
          echo "Analysis duration:           23.5 seconds"
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ Issue Severity Breakdown                        â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸ”´ Critical:           2 issues                 â”‚"
          echo "â”‚ ğŸŸ  Error:              5 issues                 â”‚"
          echo "â”‚ ğŸŸ¡ Warning:           12 issues                 â”‚"
          echo "â”‚ ğŸ”µ Review:            23 issues                 â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ Total Issues:         42                        â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "Issue Density:               3.27 issues/KLOC"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Top Issue Categories"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "1. Security.Injection.SQL              (2 Critical)"
          echo "   â†’ src/controllers/userController.js:45"
          echo "   â†’ src/routes/api.js:128"
          echo ""
          echo "2. Security.XSS                        (3 Error)"
          echo "   â†’ src/middleware/sanitize.js:23"
          echo "   â†’ src/views/renderProfile.js:67"
          echo "   â†’ src/utils/htmlBuilder.js:91"
          echo ""
          echo "3. Quality.Complexity                  (7 Warning)"
          echo "   â†’ src/services/dataProcessor.js:156 (CC: 47)"
          echo "   â†’ src/controllers/adminController.js:89 (CC: 31)"
          echo ""
          echo "4. Best Practice Violations            (15 Review)"
          echo "   â†’ Missing error handling in async functions"
          echo "   â†’ Inconsistent null checks"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ˆ Code Quality Metrics"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Average Cyclomatic Complexity:    4.2"
          echo "Maximum Cyclomatic Complexity:    47 (src/services/dataProcessor.js)"
          echo "Functions with CC > 15:           8"
          echo ""
          echo "Code duplication:                 2.3%"
          echo "Comment density:                  18.5%"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Klocwork analysis completed successfully"
          echo ""
          echo "ğŸ“„ Full report: https://klocwork.demo.cloudbees.io/review/project/hackers-org-p4"
          echo ""
          echo "Uploading results to Klocwork server..."
          sleep 2
          echo "âœ“ Results uploaded successfully"
          echo ""

          # Set outputs
          echo "2" >> $CLOUDBEES_OUTPUTS/CRITICAL_COUNT
          echo "5" >> $CLOUDBEES_OUTPUTS/ERROR_COUNT
          echo "12" >> $CLOUDBEES_OUTPUTS/WARNING_COUNT
          echo "23" >> $CLOUDBEES_OUTPUTS/REVIEW_COUNT
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Klocwork Static Analysis Results

            **Analysis Summary**
            - Files analyzed: 147
            - Lines of code: 12,847
            - Issue density: 3.27 issues/KLOC

            | Severity   | Issue Count | Status |
            |------------|-------------|--------|
            | ğŸ”´ Critical | ${{ steps.KlocworkAnalysis.outputs.CRITICAL_COUNT }} | Requires immediate attention |
            | ğŸŸ  Error    | ${{ steps.KlocworkAnalysis.outputs.ERROR_COUNT }} | Must fix before release |
            | ğŸŸ¡ Warning  | ${{ steps.KlocworkAnalysis.outputs.WARNING_COUNT }} | Should be addressed |
            | ğŸ”µ Review   | ${{ steps.KlocworkAnalysis.outputs.REVIEW_COUNT }} | Review recommended |

            **Top Issues**
            - SQL Injection vulnerabilities detected (2 Critical)
            - XSS vulnerabilities found (3 Error)
            - High complexity functions identified (7 Warning)

            [View Full Report](https://klocwork.demo.cloudbees.io/review/project/hackers-org-p4)
          format: MARKDOWN
  deploy:
    environment: "hackers-org-p4-prod"
    steps:
      - name: Connect to Perforce Helix Core
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”Œ Connecting to Perforce Helix Core Server"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "P4PORT: ssl:perforce.demo.cloudbees.io:1666"
          echo "P4USER: cloudbees-ci"
          echo "P4CLIENT: cloudbees-ci-deploy-workspace"
          echo ""
          sleep 2
          echo "âœ“ Successfully connected to Perforce Helix Core"
          echo ""
      - name: Checkout
        uses: cloudbees-io/checkout@v1
      - name: Perforce Helix - Sync Deployment Assets
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Syncing Deployment Assets from P4 Depot"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Executing: p4 sync //depot/hackers-org-p4/main/chart/...@latest"
          echo ""
          sleep 1
          echo "//depot/hackers-org-p4/main/chart/Chart.yaml#5 - synced"
          echo "//depot/hackers-org-p4/main/chart/values.yaml#11 - synced"
          echo "//depot/hackers-org-p4/main/chart/templates/deployment.yaml#8 - synced"
          echo "//depot/hackers-org-p4/main/chart/templates/service.yaml#4 - synced"
          echo "//depot/hackers-org-p4/main/chart/templates/ingress.yaml#6 - synced"
          echo ""
          sleep 1
          echo "âœ… Deployment assets synced successfully"
          echo "Changelist: @745682"
          echo ""
      - uses: cloudbees-days/setup-kubeconfig
        name: Puppet - Initialize Kubernetes Provider
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}
      - name: Puppet - Generate and Apply Configuration
        uses: docker://alpine:latest
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ­ Puppet Enterprise - Deployment Orchestration"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Connecting to Puppet Server..."
          echo "Server: puppet.demo.cloudbees.io:8140"
          echo "Environment: production"
          sleep 2
          echo "âœ“ Connected successfully"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generating Puppet Manifests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Module: hackers_org_p4"
          echo "Version: 1.0.0"
          echo "Target nodes: k8s-prod-cluster"
          echo ""
          echo "Compiling catalog for deployment..."
          echo ""
          sleep 2
          echo "Resources to be managed:"
          echo "  â€¢ kubernetes::namespace[hackers-org-p4-prod]"
          echo "  â€¢ kubernetes::deployment[hackers-organized]"
          echo "  â€¢ kubernetes::service[hackers-org-p4-service]"
          echo "  â€¢ kubernetes::ingress[hackers-org-p4-ingress]"
          echo "  â€¢ kubernetes::configmap[app-config]"
          echo "  â€¢ kubernetes::secret[app-secrets]"
          echo ""
          sleep 2
          echo "âœ“ Catalog compiled successfully"
          echo "  Total resources: 24"
          echo "  Classes included: 6"
          echo "  Dependencies resolved: 18"
          echo ""
      - id: install-chart
        uses: cloudbees-io/helm-install@v1
        with:
          chart-location: ${{ cloudbees.workspace }}/chart
          release-name: hackers-org-p4
          namespace: ${{ vars.namespace }}
          values: |
            image:
              repository: ${{ vars.DOCKER_USER }}/hackers-organized
              tag: ${{ cloudbees.scm.sha }}
            fmKey: ${{ vars.FM_TOKEN }}
            useVPC: true
            fmInstance: demo1.cloudbees.io
            hostname: hackers-org-p4.hackers-org-p4-prod.preview.cb-demos.io
      - name: Puppet - Apply Resources to Cluster
        uses: docker://alpine:latest
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Puppet Agent - Applying Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Starting Puppet agent run..."
          echo "Agent version: 8.4.0"
          echo "Run mode: apply"
          echo "Target: k8s-prod-cluster"
          echo ""
          sleep 1
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Applying Kubernetes Resources via Puppet"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Notice: /Stage[main]/Hackers_org_p4::Deploy/Kubernetes::Namespace[hackers-org-p4-prod]"
          echo "  âœ“ Namespace 'hackers-org-p4-prod' is in sync"
          echo ""
          sleep 2
          echo "Notice: /Stage[main]/Hackers_org_p4::Deploy/Kubernetes::Deployment[hackers-organized]"
          echo "  âŸ³ Updating deployment 'hackers-organized'"
          echo "    â€¢ Image: ${{ vars.DOCKER_USER }}/hackers-organized:${{ cloudbees.scm.sha }}"
          echo "    â€¢ Replicas: 3"
          echo "    â€¢ Strategy: RollingUpdate"
          sleep 3
          echo "  âœ“ Deployment updated successfully"
          echo "  âœ“ Pods rolling out: 3/3 ready"
          echo ""
          sleep 2
          echo "Notice: /Stage[main]/Hackers_org_p4::Deploy/Kubernetes::Service[hackers-org-p4-service]"
          echo "  âœ“ Service 'hackers-org-p4-service' configured"
          echo "    â€¢ Type: LoadBalancer"
          echo "    â€¢ Port: 80 -> 3000"
          echo ""
          sleep 1
          echo "Notice: /Stage[main]/Hackers_org_p4::Deploy/Kubernetes::Ingress[hackers-org-p4-ingress]"
          echo "  âœ“ Ingress rules updated"
          echo "    â€¢ Host: hackers-org-p4.hackers-org-p4-prod.preview.cb-demos.io"
          echo "    â€¢ TLS: enabled"
          echo ""
          sleep 1
          echo "Notice: /Stage[main]/Hackers_org_p4::Config/Kubernetes::Configmap[app-config]"
          echo "  âœ“ ConfigMap synchronized"
          echo "    â€¢ FM_INSTANCE: demo1.cloudbees.io"
          echo "    â€¢ USE_VPC: true"
          echo ""
          echo "Notice: /Stage[main]/Hackers_org_p4::Config/Kubernetes::Secret[app-secrets]"
          echo "  âœ“ Secrets updated (values redacted)"
          echo ""
          sleep 2
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Puppet Run Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "  Resources:"
          echo "    Total:                24"
          echo "    Changed:              6"
          echo "    Unchanged:           18"
          echo "    Failed:               0"
          echo "    Skipped:              0"
          echo ""
          echo "  Timing:"
          echo "    Catalog application:  14.8s"
          echo "    Total run time:       18.2s"
          echo ""
          echo "  Changes:"
          echo "    âœ“ Deployment image updated to ${{ cloudbees.scm.sha }}"
          echo "    âœ“ Ingress rules synchronized"
          echo "    âœ“ ConfigMap refreshed"
          echo "    âœ“ Secrets updated"
          echo "    âœ“ Service endpoints verified"
          echo "    âœ“ All pods healthy and ready"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Puppet run completed successfully"
          echo ""
          echo "Notice: Applied catalog in 14.8 seconds"
          echo ""
          echo "ğŸ”— View run details: https://puppet.demo.cloudbees.io/nodes/k8s-prod-cluster/reports"
          echo ""
      - name: Publish evidence
        uses: cloudbees-io/publish-evidence-item@v1
        with:
          content: |-
            ## Deployed environment

            **Deployment Method:** Puppet Enterprise
            - Puppet Server: puppet.demo.cloudbees.io:8140
            - Environment: production
            - Resources managed: 24 (6 changed, 18 unchanged)
            - Catalog application time: 12.3s

            **Application Details:**
            - [Production frontend](https://hackers-org-p4.hackers-org-p4-prod.preview.cb-demos.io/)
            - Image: hackers-organized:${{ cloudbees.scm.sha }}
            - Replicas: 3
            - Deployment strategy: RollingUpdate

            [View Puppet Report](https://puppet.demo.cloudbees.io/nodes/k8s-prod-cluster/reports)
          format: MARKDOWN
      - name: Register_deployed_artifact
        uses: https://github.com/cloudbees-io/register-deployed-artifact@v2
        with:
          artifact-id: ${{ needs.build-container-image.outputs.artifact-id }}
          target-environment: "hackers-org-p4-prod"
    needs:
      - build-container-image
      - scan
